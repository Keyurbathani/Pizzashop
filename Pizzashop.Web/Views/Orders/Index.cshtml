@{
    ViewData["Title"] = "Orders";
    Layout = "_DashboardLayout";
}

<form method="post" id="date-search">

    <div class="d-flex justify-content-between header-status">

        <h1 class="text-header mb-2 p-2">Orders</h1>

        <div class="d-flex align-items-center gap-2 status-filter">


            <div class="input-group">
                <input type="search" name="searchString" id="search-orders" placeholder="Search"
                    class="form-control border-end-0">
                <span class="input-group-text bg-white border-start-0">
                    <i class="fa-solid fa-search"></i>
                </span>
            </div>

            <select id="order-status" name="status" class="form-select" aria-label="Default select example">
                <option selected value="">All Orders</option>
                <option value="Pending">Pending</option>
                <option value="InProgress">In Progress</option>
                <option value="Served">Served</option>
                <option value="Completed">Completed</option>
                <option value="Cancelled">Cancelled</option>
            </select>

            <select id="order-time" name="pastDays" class="form-select" aria-label="Default select example">
                <option selected value="all">All Time</option>
                <option value="7">Last 7 Days</option>
                <option value="30">Last 30 Days</option>
                <option value="month">Current Month</option>
            </select>

            <button id="export-tax-btn" type="submit"
                class="btn btn-primary py-2 px-3 text-decoration-none rounded-1 bg-header text-white mx-2 text-nowrap export-normal">
                <i class="fa-solid fa-share-from-square me-1"></i>
                <span> Export</span>
            </button>

        </div>

    </div>


    <div class="d-flex justify-content-end date-filter gap-2 my-3">

        <div class="form-floating">
            <input type="date" name="fromDate" id="fromDate" class="form-control" placeholder="Start Date">
            <label for="fromDate">From Date</label>
        </div>

        <div class="form-floating">
            <input type="date" name="toDate" id="toDate" class="form-control" placeholder="End Date">
            <label for="toDate">To Date</label>
        </div>


        <div class="">
            <button id="search-btn" type="submit"
                class="btn btn-primary py-2 px-3 text-decoration-none rounded-1 bg-header text-white ms-1 text-nowrap">
                Search
            </button>

            <button id="clear-btn" type="reset"
                class="btn border-primary rounded-0 text-primary py-2 px-3 text-decoration-none rounded-1 mx-2 text-nowrap">
                Clear
            </button>

        </div>

    </div>
</form>




<div id="order-partial" class="mx-2">
    @* Orders *@
</div>

@section Scripts {

    <script>

        var page = 1, pagesize = 5, searchString = "", sortColumn = "", isAsc = true, status = "", fromDate = "", toDate = "";


        function getOrders() {
            $.ajax({
                type: "GET",
                url: "/Orders/GetPagedOrders",
                data: { page, pagesize, searchString, sortColumn, isAsc, status, fromDate, toDate },
                success: function (response) {
                    $("#order-partial").html(response);
                }
            });
        }


        $(document).ready(function () {

            getOrders();


            var today = new Date().toISOString().split("T")[0];
            $("#fromDate").attr("max", today)
            $("#toDate").attr("max", today)

            $("#fromDate").change(function () {
                var date = $(this).val();
                $("#toDate").attr("min", date);
            });

            $("#toDate").change(function () {
                var date = $(this).val();
                $("#fromDate").attr("max", date);
            });


       
                $("#order-time").change(function () {
                    var pastDay = $(this).val();
                    var date = new Date();
                    if (pastDay === "all") {
                        fromDate = "";
                        toDate = "";
                        getOrders();
                        return;
                    }
                    else if (pastDay === "month") {
                        fromDate = new Date(date.getFullYear(), date.getMonth(), 1);
                        toDate = new Date(date.getFullYear(), date.getMonth() + 1, 0);
                    }
                    else {
                        fromDate = new Date(date);  // Clone current date
                        fromDate.setDate(fromDate.getDate() - parseInt(pastDay));  // Subtract the selected number of days
                        toDate = new Date(date);
                    }


                    fromDate = fromDate.toISOString().split('T')[0];
                    toDate = toDate.toISOString().split('T')[0];

                    getOrders();

                })


            $("#date-search").submit(function (e) {

                e.preventDefault();
                fromDate = $("#fromDate").val();
                toDate = $("#toDate").val();
                searchString = $("#search-orders").val()
                status = $("#order-status").val()

                getOrders();

            })






            // Sorting

            $(document).on("click", ".sort", function () {
                var newSortColumn = $(this).data("sortcolumn");

                /* console.log(" newSortColumn :" , newSortColumn);
                console.log(" sortColumn :" , sortColumn); */

                if (newSortColumn == sortColumn) {
                    isAsc = !isAsc;
                }
                else {
                    isAsc = true;
                }
                sortColumn = newSortColumn;
                getOrders();
            })

            // Pagination

            $(document).on("change", "#orders-pagination #pagesizelist", function () {

                pagesize = $(this).val();
                page = 1
        @* console.log("pagesizeforchange :", pagesize) *@

                    getOrders();

            });

            // ExportOrders

            $("#export-tax-btn").on("click", function () {
                let searchString = $("#search-orders").val();
                let status = $("#order-status").val();
                let pastDays = $("#order-time").val();

                toastr.success("Orders Exported Successfully");

                let url = `/Orders/ExportOrders?pastDays=${encodeURIComponent(pastDays)}&status=${encodeURIComponent(status)}&searchString=${encodeURIComponent(searchString)}`;

                window.location.href = url;

            });


            $("#clear-btn").click(function () {
                searchString = "";
                status = "";
                fromDate = "";
                toDate = "";
                $("#search-orders").val("");
                $("#order-status").val("");
                $("#order-time").val("all");
                getOrders();
            })


        });

        function prevPage() {
            page--;
            getOrders();
        }
        function nextPage() {
            page++;
            getOrders();
        }


    </script>
}